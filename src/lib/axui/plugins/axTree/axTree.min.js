class axTree{constructor(e,t){return this.targetDom=axIdToDom(e),this.options=axExtend({insName:"",storageName:"",toggle:!0,collapseAll:!0,disabled:[],expanded:[],checked:[],selected:[],readonly:[],selectable:!0,oneSelected:!0,arrowIcon:["ax-icon-right","ax-icon-right","ax-none"],clickLineTo:"",parentIcon:["ax-icon-folder","ax-icon-folder-open"],childIcon:"ax-icon-file-text",iconShow:!1,checkboxIcon:["ax-icon-square","ax-icon-check-s","ax-icon-check-s-f"],radioIcon:["ax-icon-circle","ax-icon-radio","ax-icon-radio-f"],checkShow:!1,checkType:"checkbox",checkMin:0,checkMax:1e6,linkage:!0,oneRadio:!1,url:"",inputWidth:"",toolsShow:!1,toolsAction:"hover",addTools:[],rootStart:-1,idStart:0,draggable:!1,line:!1,async:"",ajaxType:"post",delay:0,fields:"",content:"",display:"inline",popup:{},output:{enable:!1,connector:"/",type:"",from:"checked",receiver:"",separator:","},onBeforeRemove:"",onGetCheckeds:"",onInit:"",onCollapse:"",onExpand:"",onCollapsed:"",onExpanded:"",onCollapseAll:"",onExpandAll:"",onSetReadonly:"",onSetDisabled:"",onSetChecked:"",onSearched:"",onRemoved:"",onEditing:"",onEdited:"",onAdded:"",onSelected:"",onPlanted:"",onChecked:"",onDropped:"",onTooMuch:"",onTooLittle:"",onDestroy:"",onSave:"",onUpdate:"",onUpdateContent:""},t,this.targetDom,this.constructor.name),this.handlers={},this.init(),this}begin(){this.checked=[],this.checkeds=[],this.expanded=[],this.selected=this.options.selected,this.options.oneSelected&&!axIsEmpty(this.selected)&&this.selected.shift(),this.disabled=this.options.disabled,this.arrowSame=this.options.arrowIcon[0]==this.options.arrowIcon[1],this.arrow=axAddElem("i",{class:"ax-iconfont",arrow:""}),this.checkIcon={checkbox:['<i class="ax-iconfont '+this.options.checkboxIcon[0]+'" check></i>','<i class="ax-iconfont '+this.options.checkboxIcon[1]+'" check></i>','<i class="ax-iconfont '+this.options.checkboxIcon[2]+'" check></i>'],radio:['<i class="ax-iconfont '+this.options.radioIcon[0]+'" check></i>','<i class="ax-iconfont '+this.options.radioIcon[1]+'" check></i>','<i class="ax-iconfont '+this.options.radioIcon[2]+'" check></i>']},this.fileIcon="",this.options.iconShow&&(this.fileIcon={parent:'<i class="ax-iconfont '+this.options.parentIcon[0]+'" legend></i>',child:'<i class="ax-iconfont '+this.options.childIcon+'" legend></i>'}),this.selecteds=[],this.disableds=[],this.searchs=[],this.readonlys=[],this.expandeds=[],this.floorMax=0,this.maxIndex=this.options.idStart,this.rawHTML="","popup"===this.options.display?(this.receiver=this.targetDom,this.options.output.enable=!0,("INPUT"===this.receiver.nodeName||"TEXTAREA"===this.receiver.nodeName)&&this.receiver.setAttribute("readonly",""),this.targetDom=axAddElem("ul",{class:"ax-tree"}),this.popup=new axPopup(this.receiver,axExtend({content:this.targetDom,placement:"bottom-start",footerShow:!1},this.options.popup))):this.receiver=this.options.output.enable&&this.options.output.receiver?axIdToDom(this.options.output.receiver):null,this.flatData=[],this.treeData=[]}async init(){if(axInstance.push(this,this.options.insName,"tree"),this.destroyed=!1,this.options.storageName){let e=axLocalStorage.get(this.options.storageName);axIsEmpty(e)?axLocalStorage.set(this.options.storageName,{}):this.options=axExtend(this.options,e)}if(this.begin(),"String"==axType(this.options.content)&&this.options.async)await axTreeMethod.fullData({source:this.options.content,ajaxType:this.options.ajaxType,ajaxData:"sql"===this.options.async?{pId:this.options.rootStart}:"",rootStart:this.options.rootStart,idStart:this.options.idStart,async:!0,opened:e=>{this.contentXhr=e.xhr},before:e=>{this.targetDom.innerHTML=e.content},success:()=>{this.targetDom.innerHTML=""}}).then(e=>{this.treeData=e.data});else if("Array"===axType(this.options.content)){if(0===this.options.content.length)return console.warn("Array is empty!"),!1;await axTreeMethod.fullData({source:this.options.content,rootStart:this.options.rootStart,idStart:this.options.idStart}).then(e=>{this.treeData=e.data})}else axType(this.options.content).includes("HTML")||axStrType(this.options.content)?await axTreeMethod.fullData({source:this.options.content,rootStart:this.options.rootStart,idStart:this.maxIndex}).then(e=>{this.treeData=e.data,this.maxIndex=e.idMax}):this.targetDom.innerHTML&&(await axTreeMethod.fullData({source:this.targetDom,rootStart:this.options.rootStart,idStart:this.maxIndex}).then(e=>{this.treeData=e.data,this.maxIndex=e.idMax}),this.rawHTML=this.targetDom.innerHTML);this.dataProcess(this.treeData)}getAsyncData(e="json",t){return axAjax({data:"sql"===e?{pId:this.options.rootStart}:"",url:this.options.content,type:this.options.ajaxType,opened:e=>{this.contentXhr=e.xhr},success:i=>{if(axIsEmpty(i.content))return console.warn(`No data obtained from ${"sql"===e?"database":"json"}!`),!1;this.toTree(i.content),t&&t(i.content)}},this.targetDom)}toTree(e){e[0].hasOwnProperty("pId")?this.treeData=axArrToTree(e,this.options.rootStart):this.treeData=e}dataProcess(e){if(this.flatData=axArrToFlat(e),this.targetDom.innerHTML="",this.setAttribute(),!this.fixChecked(this.flatData))return!1;this.refreshTree(e),this.fixExpand(this.flatData),this.arrayToDom(e),this.flatData.forEach(e=>{axIsEmpty(this.expanded)&&!this.options.collapseAll&&e.children&&(e.expanded=!1,this.ulToggle(e)),this.renderFinish(e,this.flatData)}),this.options.onInit&&this.options.onInit.call(this),"init"in this.handlers&&this.emit("init","")}setAttribute(){this.options.line&&this.targetDom.setAttribute("line",""),!this.targetDom.classList.contains("ax-tree")&&this.targetDom.classList.add("ax-tree")}dragPlace(e,t){let i=t.getBoundingClientRect().top,s=t.getBoundingClientRect().bottom,o=(t.getBoundingClientRect().bottom-t.getBoundingClientRect().top)/3,a=i+~~o,h=s-~~o,n="child";return e.clientY<a?n="up":e.clientY>h&&(n="down"),n}resetRelation(e,t,i,s){let o=(e,t)=>{"1-0"==s?(e.pId=this.options.rootStart,e.path=this.options.rootStart+">"+e.id,e.floor=1,e.indentDom.innerHTML=""):"0-1"!=s&&"other"!=s&&s||(e.pId=t.id,e.path=t.path+">"+e.id,e.floor=t.floor+1,e.indentDom.innerHTML="<i></i>".repeat(e.floor-1))},a=(e,t)=>{e.children&&e.children.length>0?e.children.forEach(t=>{o(t,e),a(t,e)}):o(e,t)};o(e,t),a(e,t),"0-1"==s?this.treeData=this.treeData.filter(t=>t.id!=e.id):"0-0"==s||"1-0"==s||(i.children=i.children.filter(t=>t.id!=e.id))}openParentBorn(e,t,i,s){let o=e.headerDom.nextElementSibling;if(t){let a=t.headerDom.parentElement;this.resetRelation(t,e,i,s),e.expanded||(e.headerDom.setAttribute("expanded","true"),e.expanded=!0,o.style.display="block"),e.children.unshift(t),o.insertAdjacentElement("afterBegin",a)}}childToParentBorn(e,t,i,s){if(e.children)return!1;{let o=axAddElem("ul",{style:"display:block"});if(e.arrowDom.classList.remove(this.options.arrowIcon[2]),e.arrowDom.classList.add(this.options.arrowIcon[0]),e.headerDom.setAttribute("expanded","true"),e.expanded=!0,e.children=[],t){let a=t.headerDom.parentElement;this.resetRelation(t,e,i,s),e.children.unshift(t),o.insertAdjacentElement("afterBegin",a)}e.headerDom.insertAdjacentElement("afterEnd",o),e.arrowDom.onclick=(()=>{this.ulToggle(e)})}}dropItem(e,t,i,s,o){let a=t.headerDom,h=a.parentElement,n=this.flatData.filter(t=>e.pId==t.id.toString())[0],r=e.headerDom.parentElement,l="up"==s?"beforeBegin":"down"==s?"afterEnd":"",d=s=>{if(this.resetRelation(t,n,i,o),"0-0"==o){let i=this.treeData.indexOf(t),o=this.treeData.indexOf(e);"up"==s?axMoveArr(this.treeData,i,o):"down"==s&&axMoveArr(this.treeData,i,o+1)}else if("1-0"==o){let i,o=this.treeData.indexOf(e);"up"==s?i=o:"down"==s&&(i=o+1),this.treeData.splice(i,0,t)}else{let i,o=n.children.indexOf(e);"up"==s?i=o:"down"==s&&(i=o+1),n.children.splice(i,0,t)}r.insertAdjacentElement(l,h)};if("up"==s){if(r.previousElementSibling==h)return!1;d("up")}else if("down"==s){if(r.nextElementSibling==h)return!1;d("down")}else e.children?this.openParentBorn(e,t,i,o):this.childToParentBorn(e,t,i,o);a.setAttribute("tabindex","-1"),a.focus(),a.onblur=(()=>{a.removeAttribute("tabindex")}),this.options.onDropped&&this.options.onDropped.call(this,t,e),"dropped"in this.handlers&&this.emit("dropped",t,e)}ulToggle(e,t=!0){let i=e.headerDom,s=e.arrowDom,o=e.legendDom,a=i.nextElementSibling;1==e.expanded?(this.options.onCollapse&&this.options.onCollapse.call(this,e),"collapse"in this.handlers&&this.emit("collapse",e),e.expanded=!1,i.removeAttribute("expanded"),this.arrowSame||(s.classList.remove(this.options.arrowIcon[1]),s.classList.add(this.options.arrowIcon[0])),this.options.iconShow&&(o.classList.remove(this.options.parentIcon[1]),o.classList.add(this.options.parentIcon[0])),this.eachExapand(e),axSlideUp(a,"",()=>{this.options.onCollapsed&&this.options.onCollapsed.call(this,e),"collapsed"in this.handlers&&this.emit("collapsed",e)})):(this.options.onExpand&&this.options.onExpand.call(this,e),"expand"in this.handlers&&this.emit("expand",e),e.expanded=!0,i.setAttribute("expanded","true"),this.arrowSame||(s.classList.remove(this.options.arrowIcon[0]),s.classList.add(this.options.arrowIcon[1])),this.options.iconShow&&(o.classList.remove(this.options.parentIcon[0]),o.classList.add(this.options.parentIcon[1])),this.eachExapand(e),console.log(i),axSlideDown(a,"",()=>{this.options.onExpanded&&this.options.onExpanded.call(this,e),"expanded"in this.handlers&&this.emit("expanded",e)}),t&&this.siblingsCollapse(this.flatData,e)),this.save()}selectItem(e,t){if(e.headerDom.hasAttribute("editing")||!this.options.selectable)return!1;let i=t.filter(t=>t!=e);1==e.selected?(e.selected=!1,this.eachSelect(e)):(e.selected=!0,this.eachSelect(e),this.options.oneSelected&&i.forEach(e=>{1==e.selected&&(e.selected=!1,this.eachSelect(e))}),this.options.onSelected&&this.options.onSelected.call(this,e),"selected"in this.handlers&&this.emit("selected",e)),this.receiverAssign()}checkItem(e,t){if(!e.checkDom||e.disabled)return!1;if(this.checkeds.length>this.options.checkMax&&!e.checked)return console.warn("The length of checked is too much!"),this.options.onTooMuch&&this.options.onTooMuch.call(this,this.checkeds.length,this.options.checkMax),"tooMuch"in this.handlers&&this.emit("tooMuch",this.checkeds.length,this.options.checkMax),!1;if("checkbox"==this.options.checkType)1==e.checked?e.checked=!1:e.checked=!0,this.eachCheckbox(e,this.options.linkage),this.options.onGetCheckeds&&this.options.onGetCheckeds.call(this,this.checkeds,e);else if("radio"==this.options.checkType){let i=t.filter(t=>t.pId==e.pId);if(i.some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;if(this.options.oneRadio&&t.some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;1==e.checked?e.checked=!1:e.checked=!0,this.eachRadio(e,this.options.linkage),this.options.onGetCheckeds&&this.options.onGetCheckeds.call(this,this.checkeds,e)}this.options.onChecked&&this.options.onChecked.call(this,e,this.checkeds),"checked"in this.handlers&&this.emit("checked",e,this.checkeds),this.receiverAssign()}siblingsCollapse(e,t){if(this.options.toggle){let i=e.filter(e=>e.pId==t.pId&&e.children&&e!=t);for(let e of i)e.headerDom.nextElementSibling&&(e.expanded=!0,this.ulToggle(e))}}renderFinish(e,t){let i=e.headerDom.parentElement;e.arrowDom.classList.contains(this.options.arrowIcon[2])||(e.arrowDom.onclick=(()=>{if(!e.expanded&&"sql"==this.options.async){let t=e.headerDom.nextElementSibling;t||(t=axAddElem("ul"),e.headerDom.insertAdjacentElement("afterEnd",t)),t.querySelector("li")||axAjax({data:{pId:e.id},type:this.options.ajaxType,url:this.options.content,opened:e=>{this.contentXhr=e.xhr},before:()=>{e.arrowDom.setAttribute("loading","")},success:i=>{if(axIsEmpty(i.content))return console.warn("No data obtained!"),!1;e.arrowDom.removeAttribute("loading"),t.innerHTML="",i.content.forEach(t=>{this.add(t,e,!0,!1)})}})}this.ulToggle(e)})),this.selected.map(String).includes(e.id.toString())&&(e.selected=!0,this.eachSelect(e)),this.options.checkShow&&(this.disabled.map(String).includes(e.id.toString())&&(e.disabled=!0,this.eachDisabled(e)),this.checked.map(String).includes(e.id.toString())&&(e.checked=!0,"checkbox"==this.options.checkType?this.eachCheckbox(e,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(e,this.options.linkage)),e.checkDom.onclick=(()=>{this.checkItem(e,t)}),"check"===this.options.clickLineTo&&(e.wrapperDom.onclick=(i=>{[e.headerDom,e.labelDom,e.indentDom,e.legendDom].includes(i.target)&&this.checkItem(e,t)}))),this.options.toolsShow&&(e.removeDom.onclick=(()=>{if(e.readonly)return!1;if(this.options.onBeforeRemove){let t=this.options.onBeforeRemove.call(this,e,e.removeDom);t&&this.remove(e)}else this.remove(e)}),e.editDom.onclick=(()=>{if(e.readonly)return!1;this.edit(e)}),e.addDom.onclick=(()=>{if(e.readonly)return!1;this.add("",e)})),e.labelDom&&(e.labelDom.onclick=(()=>{this.selectItem(e,t),e.toolsDom&&"click"==this.options.toolsAction&&(e.selected?e.toolsDom.style.display="inline-block":e.toolsDom.style.display="none")}),e.labelDom.ondblclick=(()=>{if(e.readonly)return!1;this.edit(e)}),"select"===this.options.clickLineTo&&(e.wrapperDom.onclick=(i=>{[e.headerDom,e.indentDom,e.legendDom].includes(i.target)&&this.selectItem(e,t)}))),1==this.options.draggable?(i.setAttribute("draggable","true"),i.addEventListener("dragstart",t=>{t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)},!1)):"Array"==axType(this.options.draggable)&&this.options.draggable.map(String).includes(e.id.toString())&&(i.setAttribute("draggable","true"),i.addEventListener("dragstart",t=>{t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)},!1)),e.headerDom.addEventListener("dragenter",e=>{e.preventDefault()},!1),e.headerDom.addEventListener("dragover",t=>{t.preventDefault(),i.classList.add("ax-dragging"),i.setAttribute("insert",this.dragPlace(t,e.headerDom))},!1),e.headerDom.addEventListener("dragleave",e=>{e.preventDefault(),i.classList.remove("ax-dragging"),i.removeAttribute("insert")},!1),e.headerDom.addEventListener("drop",t=>{t.preventDefault();let s,o=t.dataTransfer.getData("id"),a=this.flatData.filter(e=>o==e.id.toString())[0],h=this.flatData.filter(e=>a.pId==e.id)[0];if(s=e.pId==a.pId&&e.pId==this.options.rootStart&&"child"!=this.dragPlace(t,e.headerDom)?"0-0":e.pId==this.options.rootStart&&"child"!=this.dragPlace(t,e.headerDom)?"1-0":a.pId==this.options.rootStart?"0-1":"other",i.classList.remove("ax-dragging"),i.removeAttribute("insert"),e==a)return!1;this.dropItem(e,a,h,this.dragPlace(t,e.headerDom),s)},!1),this.save()}getParents(e,t="obj"){let i=[],s=[];if("Array"==axType(e)){let t=this.flatData.filter(t=>e.map(String).includes(t.id.toString()));t.forEach(e=>{let t=e.path.split(">").filter(t=>t.id!=this.options.rootStart&&t!=e.id);i.push(...t)})}else if("Object"==axType(e)){let t=e.path.split(">").filter(t=>t.id!=this.options.rootStart&&t!=e.id);i.push(...t)}else{let t=this.flatData.filter(t=>t.id==e)[0],s=t.path.split(">").filter(e=>e.id!=this.options.rootStart&&e!=t.id);i.push(...s)}return i=[...new Set(i)],s=this.flatData.filter(e=>i.includes(e.id.toString())),"obj"==t?s:"id"==t?i:{obj:s,id:i}}getChildren(e){let t=[];return"Array"==axType(e)?e.forEach(e=>{let i=this.flatData.filter(t=>t.path.includes(">"+e+">"));t.push(...i)}):t="Object"==axType(e)?this.flatData.filter(t=>t.path.includes(">"+e.id+">")):this.flatData.filter(t=>t.path.includes(">"+e+">")),t}eachSelect(e){if(1==e.selected)e.headerDom.setAttribute("selected","true"),!this.selecteds.includes(e)&&this.selecteds.push(e);else{e.headerDom.removeAttribute("selected");for(let t=0;t<this.selecteds.length;t++)if(this.selecteds[t]==e){this.selecteds.splice(t,1);break}}}eachDisabled(e){let t=(e,t)=>{if(t)e.headerDom.setAttribute("disabled","true"),!this.disableds.includes(e)&&this.disableds.push(e);else{e.headerDom.removeAttribute("disabled");for(let t=0;t<this.disableds.length;t++)if(this.disableds[t]==e){this.disableds.splice(t,1);break}}},i=(e,s)=>{if(e.disabled=s,t(e,s),e.children&&e.children.length>0){let t=[...e.children].filter(e=>!e.disabled);t.forEach(e=>{i(e,s)})}};1==e.disabled?(t(e,!0),"checkbox"==this.options.checkType&&i(e,!0)):(t(e,!1),"checkbox"==this.options.checkType&&i(e,!1))}eachExapand(e){if(1==e.expanded)e.headerDom.setAttribute("expanded","true"),!this.expandeds.includes(e)&&this.expandeds.push(e);else{e.headerDom.removeAttribute("expanded");for(let t=0;t<this.expandeds.length;t++)if(this.expandeds[t]==e){this.expandeds.splice(t,1);break}}}checkToggle(e,t,i){let s=e.headerDom,o=s.querySelector("[check]"),a="checkbox"==i?"checkboxIcon":"radio"==i?"radioIcon":"";1==t?(e.checked=!0,s.setAttribute("checked","true"),o.classList.remove(this.options[a][0],this.options[a][1]),o.classList.add(this.options[a][2])):0==t?(e.checked=!1,s.setAttribute("checked","false"),o.classList.remove(this.options[a][1],this.options[a][2]),o.classList.add(this.options[a][0])):"ing"==t&&(e.checked="ing",s.setAttribute("checked","ing"),o.classList.remove(this.options[a][0],this.options[a][2]),o.classList.add(this.options[a][1]))}eachCheckbox(e,t){if(t){let t=e=>{let i=e.children;i?1==e.checked?(this.checkToggle(e,!0,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!0,t(e))})):e.checked||(this.checkToggle(e,!1,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!1,t(e))})):1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked||this.checkToggle(e,!1,"checkbox")},i=e=>{let t=e.path.split(">").filter(t=>t!==this.options.rootStart&&t!=e.id),i=this.flatData.filter(e=>t.includes(e.id.toString())).reverse();i.forEach(e=>{e.children.filter(e=>!e.disabled).every(e=>!e.checked)?this.checkToggle(e,!1,"checkbox"):e.children.filter(e=>!e.disabled).every(e=>1==e.checked)?this.checkToggle(e,!0,"checkbox"):e.children.some(e=>1==e.checked||"ing"==e.checked)&&this.checkToggle(e,"ing","checkbox")})};t(e),i(e)}else 1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked?this.checkToggle(e,"ing","checkbox"):this.checkToggle(e,!1,"checkbox");this.checkeds=[];let i=this.flatData.filter(e=>1==e.checked);i.forEach(e=>{this.checkeds.push(e)}),this.checkeds.length>this.options.checkMax?(console.warn("The length of checked is too much!"),this.options.onTooMuch&&this.options.onTooMuch.call(this,this.checkeds.length,this.options.checkMax),"tooMuch"in this.handlers&&this.emit("tooMuch",this.checkeds.length,this.options.checkMax)):this.checkeds.length<this.options.checkMin&&(console.warn("The length of checked is too little!"),this.options.onTooLittle&&this.options.onTooLittle.call(this,this.checkeds.length,this.options.checkMin),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checkeds.length,this.options.checkMin))}eachRadio(e,t){if(1==e.checked){let t=[];t=this.options.oneRadio?this.flatData.filter(t=>1==t.checked&&t!=e):this.flatData.filter(t=>t.pId==e.pId&&1==t.checked&&t!=e),t.forEach(e=>{this.checkToggle(e,!1,"radio")}),this.checkToggle(e,!0,"radio")}else this.checkToggle(e,!1,"radio");if(t){let t=()=>{let t=this.flatData.filter(e=>1==e.checked),i=[];t.forEach(e=>{let t=e.path.split(">").filter(t=>t!==this.options.rootStart&&t!=e.id);i.push(...t)}),i=[...new Set(i)];let s=this.flatData.filter(e=>i.includes(e.id.toString())),o=this.flatData.filter(t=>t.children&&t!=e&&!t.checked);o.forEach(e=>{e.checked&&this.checkToggle(e,!1,"radio")}),axIsEmpty(s)||s.forEach(e=>{1==e.checked?this.checkToggle(e,!0,"radio"):this.checkToggle(e,"ing","radio")})};t()}this.checkeds=[];let i=this.flatData.filter(e=>1==e.checked);i.forEach(e=>{this.checkeds.push(e)})}arrange(e){let t=[];return e.forEach((i,s)=>{let o=e.slice(s+1,e.length);o.forEach(e=>{let s=[];s=[i,e],t.push(s)})}),t}fixChecked(e){let t=!0;return this.options.checked.length>this.checkMax?(console.warn("The length of checked has been automatically intercepted!"),this.options.onTooMuch&&this.options.onTooMuch.call(this,this.options.checked.length,this.checkMax),"tooMuch"in this.handlers&&this.emit("tooMuch",this.options.checked.length,this.checkMax),this.checked=this.options.checked.splice(this.checkMax)):this.checked=this.options.checked,this.checked.length<this.checkMin&&(console.error("The length of checked has exceeded the limit!"),this.options.onTooLittle&&this.options.onTooLittle.call(this,this.checked.length,this.checkMin),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checked.length,this.checkMin),t=!1),"radio"==this.options.checkType&&this.checked.length>1?(t=!this.arrange(this.checked).some(t=>e.find(e=>e.id==t[0]).pId==e.find(e=>e.id==t[1]).pId),t||console.error("Only one item can be selected at the same level!")):this.options.checkType,t}fixExpand(e){let t=[];e.forEach(e=>{let i=e.path.split(">").filter(e=>e!=this.options.rootStart);if(this.options.expanded.map(String).includes(i[i.length-1])&&t.push(...i),e.children&&e.children.length>0){let t=[];e.children.forEach(e=>{t.push(e.id)}),this.options.linkage&&(t.every(e=>this.checked.map(String).includes(e.toString()))?e.checked=!0:t.some(e=>this.checked.map(String).includes(e.toString()))&&(e.checked="ing"))}}),this.expanded=[...new Set(t)],this.expanded.forEach(t=>{let i=e.find(e=>t==e.id&&e.children);i&&(i.expanded=!0)})}createItem(e,t){let i="",s='<span tools><i class="ax-iconfont ax-icon-plus" add></i><i class="ax-iconfont ax-icon-edit" edit></i><i class="ax-iconfont ax-icon-trash" remove></i></span>';"checkbox"==this.options.checkType&&this.options.checkShow?e.hasOwnProperty("checked")?1==e.checked?i=this.checkIcon.checkbox[2]:"ing"==e.checked&&(i=this.checkIcon.checkbox[1]):i=this.checkIcon.checkbox[0]:"radio"==this.options.checkType&&this.options.checkShow&&(e.hasOwnProperty("checked")?1==e.checked?i=this.checkIcon.radio[2]:"ing"==e.checked&&(i=this.checkIcon.radio[1]):i=this.checkIcon.radio[0]);let o=`<i class="${this.arrowSame?"":"ax-different"} ax-iconfont ${e.children?this.options.arrowIcon[0]:this.options.arrowIcon[2]}" arrow></i>`,a=`\n                        <div class="ax-node" >\n                            <span indent>${"<i></i>".repeat(t-1)}</span>\n                            ${o}\n                            ${i}\n                            <# if(this.children){ #>${this.fileIcon?this.fileIcon.parent:""}<# } else { #>${this.fileIcon?this.fileIcon.child:""} <# } #>\n                            <i label><# this.label #></i>\n                            ${this.options.toolsShow?s:""}\n                        </div>`;return e.headerDom=axStrToDom(axTplEngine(a,e)),e.toolsDom=e.headerDom.querySelector("[tools]"),e.indentDom=e.headerDom.querySelector("[indent]"),e.arrowDom=e.headerDom.querySelector("[arrow]"),e.labelDom=e.headerDom.querySelector("[label]"),e.legendDom=e.headerDom.querySelector("[legend]"),e.checkDom=e.headerDom.querySelector("[check]"),e.otherTools=[],axIsEmpty(this.options.addTools)||this.options.addTools.forEach(t=>{let i={dom:axStrToDom(t.dom),callback:t.callback};e.otherTools.push(i),i.dom.onclick=(()=>{i.callback.call(this,e)}),e.toolsDom.insertAdjacentElement("afterBegin",i.dom)}),e.addDom=e.headerDom.querySelector("[add]"),e.editDom=e.headerDom.querySelector("[edit]"),e.removeDom=e.headerDom.querySelector("[remove]"),e.callback&&e.callback.call(this,e),e.headerDom}addAttritue(e,t){t.setAttribute("mark",e.id),this.options.readonly.map(String).includes(e.id.toString())&&this.readonly(e),this.eachExapand(e),this.options.toolsShow&&t.setAttribute("toolsAction",this.options.toolsAction)}refreshTree(e){return this.floorMax=axTreeMethod.addPath(e,this.options.rootStart).floorMax,this.flatData=axArrToFlat(this.treeData),e}arrayToDom(e){let t=axAddElem("ul"),i=document.createDocumentFragment(),s=(e,t)=>{let i=axAddElem("ul");return t.forEach(e=>{e.headerDom=this.createItem(e,e.floor),e.wrapperDom=axAddElem("li"),this.addAttritue(e,e.headerDom),e.wrapperDom.appendChild(e.headerDom),e.hasOwnProperty("children")&&s(e.wrapperDom,e.children),i.appendChild(e.wrapperDom)}),e.appendChild(i),e};s(t,e);let o=t.childNodes[0].childNodes;[...o].forEach(e=>{i.appendChild(e)}),this.targetDom.appendChild(i);let a=this.targetDom.querySelectorAll("[expanded]");[...a].forEach(e=>{e.nextElementSibling.style.display="block"}),this.options.onPlanted&&this.options.onPlanted.call(this),"planted"in this.handlers&&this.emit("planted","")}getItemsFromPath(e,t=this.options.output.connector){let i=e.split(">"),s=i.map(e=>this.flatData.find(t=>t.id==e)).filter(Boolean),o=s.map(e=>e.value||e.label).join(t);return{items:s,path:o}}receiverAssign(){this.receiver&&("INPUT"===this.receiver.nodeName||"TEXTAREA"===this.receiver.nodeName?this.receiver.value=this.getValues():this.receiver.innerHTML=this.getValues())}getValues(e={}){let t=e.type||this.options.output.type,i=e.connector||this.options.output.connector,s=e.separator||this.options.output.separator,o=e.isString||!0,a=e.from||this.options.output.from,h="checked"===a?this.checkeds:this.selecteds,n=[];return n="ultimate"===t?h.filter(e=>!e.children).map(e=>e.value||e.label):"parent"===t?h.filter(e=>e.children).map(e=>e.value||e.label):"chain"===t?h.map(e=>this.getItemsFromPath(e.path,i).path):h.map(e=>e.value||e.label),o?n.join(s):n}add(e,t,i=!0,s=!0,o){if(this.destroyed)return this;let a;t||0===t?a=axFindItem(t,this.flatData):(a=this.flatData.filter(e=>1===e.floor).slice(-1)[0],i=!1,s=!1);let h=a.headerDom,n={};if(axIsEmpty(e)||"object"!=typeof e){let t=axIncreaseId(this.flatData),s=e&&"string"==typeof e?e:"新节点"+t;n=i?{id:t,label:s,pId:a.id,path:a.path+">"+t,floor:a.floor+1}:{id:t,label:s,pId:a.pId,path:a.path.replace(new RegExp("(.*)"+a.id),"$1"+t),floor:a.floor}}else{let t=i?{path:a.path+">"+e.id,floor:a.floor+1}:{path:a.path.replace(new RegExp("(.*)"+a.id),"$1"+e.id),floor:a.floor};n=Object.assign(e,t)}if(n.headerDom=this.createItem(n,n.floor),n.wrapperDom=axAddElem("li"),this.addAttritue(n,n.headerDom),n.wrapperDom.appendChild(n.headerDom),i)if(a.children){s?a.children.unshift(n):a.children.push(n);let e=h.nextElementSibling;e.insertAdjacentElement(s?"afterBegin":"beforeEnd",n.wrapperDom),this.flatData.push(n),a.expanded||this.ulToggle(a)}else{a.children=[],s?a.children.unshift(n):a.children.push(n);let e=h.querySelector("[arrow]"),t=axAddElem("ul",{style:"display:block"});e.classList.remove(this.options.arrowIcon[2]),e.classList.add(this.options.arrowIcon[0]),a.expanded=!0,h.setAttribute("expanded","true"),t.insertAdjacentElement(s?"afterBegin":"beforeEnd",n.wrapperDom),h.insertAdjacentElement("afterEnd",t),this.flatData.push(n),this.siblingsCollapse(this.flatData,a),e.onclick=(()=>{this.ulToggle(a)})}else{let e=this.flatData.filter(e=>e.id==a.pId)[0],t=e?e.children:this.treeData,i=t.indexOf(a);s?0==i?t.unshift(n):t.splice(i,0,n):t.splice(i+1,0,n),h.parentElement.insertAdjacentElement(s?"beforeBegin":"afterEnd",n.wrapperDom),this.flatData.push(n),e&&!e.expanded&&(e.expanded=!0,this.ulToggle(e))}return this.renderFinish(n,this.flatData),n.headerDom.setAttribute("tabindex","-1"),n.headerDom.focus(),n.headerDom.onblur=(()=>{n.headerDom.removeAttribute("tabindex")}),this.options.onAdded&&this.options.onAdded.call(this,n,a),"added"in this.handlers&&this.emit("added",n,a),o&&o.call(this,n,a),this.save(),this}edit(e,t){if(this.destroyed)return this;let i=axFindItem(e,this.flatData),s=i.headerDom,o=s.querySelector("[label]"),a=axAddElem("input",{type:"text"});return!s.hasAttribute("editing")&&(s.setAttribute("editing","true"),o.innerHTML="",o.appendChild(a),a.focus(),a.value=i.label,a.onblur=(()=>{let e=a.value;s.removeAttribute("editing"),i.label=e,o.innerHTML=e,this.options.onEdited&&this.options.onEdited.call(this,i),"edited"in this.handlers&&this.emit("edited",i)}),a.onkeyup=(e=>{13==e.keyCode&&a.blur()}),this.options.onEditing&&this.options.onEditing.call(this,i),"editing"in this.handlers&&this.emit("editing",i),t&&t.call(this,i),this.save(),this)}remove(e,t){if(this.destroyed)return this;let i=axFindItem(e,this.flatData),s=i.headerDom.parentElement;if(s.remove(),i.pId&&i.pId!=this.options.rootStart){let e=this.flatData.filter(e=>e.id==i.pId)[0],t=e.children,s=t.indexOf(i);t.splice(s,1)}else this.treeData=this.treeData.filter(e=>e!=i);return this.flatData=this.flatData.filter(e=>e!=i&&!e.path.includes(">"+i.id+">")),this.options.onRemoved&&this.options.onRemoved.call(this,i),"removed"in this.handlers&&this.emit("removed",i),t&&t.call(this,i),this.save(),this}search(e,t){if(this.destroyed)return this;if(this.searchs.length>0){this.searchs.forEach(e=>{e.headerDom.querySelector("[label]").innerHTML=e.label});let e=this.treeData.filter(e=>"none"==e.headerDom.parentElement.style.display);e.forEach(e=>{e.headerDom.parentElement.removeAttribute("style")})}if(e){let t=[];this.searchs=this.flatData.filter(t=>t.label.includes(e)),this.searchs.forEach(i=>{t.push(i.id);let s=i.labelDom.innerHTML.replace(e,"<i>"+e+"</i>");i.labelDom.innerHTML=s});let i=this.getParents(t,"both"),s=[];i.obj.forEach(e=>{e.expanded=!0,e.headerDom.setAttribute("expanded","true"),e.headerDom.nextElementSibling.style.display="block"}),s=[...i.id,...t].map(String),i.id.map(String);let o=this.flatData.filter(e=>i.id.includes(e.pId.toString())&&!s.includes(e.id.toString()));this.flatData.filter(e=>!o.includes(e)).forEach(e=>{e.headerDom.parentElement.removeAttribute("style")});for(let e of o)"none"!=e.headerDom.parentElement.style.display&&(e.headerDom.parentElement.style.display="none")}else this.searchs=[],this.flatData.forEach(e=>{let t=e.headerDom.parentElement;"none"==t.style.display&&t.removeAttribute("style")});return this.options.onSearched&&this.options.onSearched.call(this,this.searchs,e),"searched"in this.handlers&&this.emit("searched",this.searchs,e),t&&t.call(this,this.searchs,e),this.save(),this}check(e,t=!0,i){if(this.destroyed)return this;let s;if("Array"==axType(e)){s=this.flatData.filter(t=>e.map(String).includes(t.id.toString()));for(let e of s)e.checked!=t&&(e.checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(e,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(e,this.options.linkage))}else{if(s=this.flatData.filter(t=>t.id==e),s.checked==t)return!1;s[0].checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(s[0],this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(s[0],this.options.linkage)}return this.options.onSetChecked&&this.options.onSetChecked.call(this,s),"setChecked"in this.handlers&&this.emit("setChecked",s),i&&i.call(this,s),this.save(),this}disable(e,t=!0,i){if(this.destroyed)return this;let s;if("Array"==axType(e)){s=this.flatData.filter(t=>e.map(String).includes(t.id.toString()));let i=[];s.forEach(e=>{i.push(...this.getChildren(e))}),i=[...new Set(i)],s.push(...i);for(let e of s)e.disabled!=t&&(e.disabled=t,this.eachDisabled(e),i.forEach(e=>{e.disabled=t,this.eachDisabled(e)}))}else{if(s.disabled==t)return!1;s=this.flatData.filter(t=>t.id==e),this.getChildren(s[0]).forEach(e=>{e.disabled=t,this.eachDisabled(e)})}return s.forEach(e=>{e.disabled=t,e.checkDom.onclick=(()=>{this.checkItem(e,this.flatData)})}),this.options.onSetDisabled&&this.options.onSetDisabled.call(this,s),"setDisabled"in this.handlers&&this.emit("setDisabled",s),i&&i.call(this,s),this.save(),this}readonly(e,t=!0,i){if(this.destroyed)return this;let s=(e,t)=>{t?(e.readonly=!0,e.headerDom.setAttribute("readonly","true")):(e.readonly=!1,e.headerDom.removeAttribute("readonly"))},o=[];if("Array"==axType(e))o=this.flatData.filter(t=>e.map(String).includes(t.id.toString())),o.forEach(e=>{s(e,t)});else if("Object"==axType(e))s(e,t),o.push(e);else{let i=this.flatData.filter(t=>t.id==e)[0];s(i,t),o.push(i)}return this.readonlys=[...this.readonlys,...o],this.readonlys=[...new Set(this.readonlys)],this.options.onSetReadonly&&this.options.onSetReadonly.call(this,o),"setReadonly"in this.handlers&&this.emit("setReadonly",o),i&&i.call(this,o),this.save(),this}expand(e,t){if(this.destroyed)return this;let i=[]
;return i="Array"==axType(e)?this.flatData.filter(t=>!t.expanded&&t.children&&e.map(String).includes(t.id.toString())):this.flatData.filter(t=>!t.expanded&&t.children&&e==t.id),i.forEach(e=>{e.expanded=!1,this.ulToggle(e,!1)}),this.expandeds=this.flatData.filter(e=>e.expanded&&e.children),t&&t.call(this,i),this}expandAll(e){if(this.destroyed)return this;let t=this.flatData.filter(e=>!e.expanded&&e.children);return t.forEach(e=>{e.expanded=!1,this.ulToggle(e,!1)}),this.expandeds=t,this.options.onExpandAll&&this.options.onExpandAll.call(this),"expandAll"in this.handlers&&this.emit("expandAll",""),e&&e.call(this),this}collapse(e,t){if(this.destroyed)return this;let i=[];return i="Array"==axType(e)?this.flatData.filter(t=>t.expanded&&t.children&&e.map(String).includes(t.id.toString())):this.flatData.filter(t=>t.expanded&&t.children&&e==t.id),i.forEach(e=>{e.expanded=!0,this.ulToggle(e,!1)}),this.expandeds=this.flatData.filter(e=>e.expanded&&e.children),t&&t.call(this,i),this}collapseAll(e){if(this.destroyed)return this;let t=this.flatData.filter(e=>e.expanded&&e.children);return t.forEach(e=>{e.expanded=!0,this.ulToggle(e,!1)}),this.expandeds=[],this.options.onCollapseAll&&this.options.onCollapseAll.call(this),"collapseAll"in this.handlers&&this.emit("collapseAll",""),e&&e.call(this),this}reset(e){return this.destroyed?this:(this.targetDom.innerHTML=this.rawHTML?this.rawHTML:"",this.init(),this.options.onReset&&this.options.onReset.call(this),"reset"in this.handlers&&this.emit("reset",""),e&&e.call(this),this)}updateContent(e,t,i){if(this.destroyed)return this;let s=axFindItem(e,this.flatData);return s&&"string"==typeof t?(s.label=t,s.labelDom.innerHTML=t,this.options.onUpdateContent&&this.options.onUpdateContent.call(this,s),"updateContent"in this.handlers&&this.emit("updateContent",s),i&&i.call(this,s),this):void 0}update(e,t){return this.destroyed?this:(this.options=axExtend(this.options,e),this.options.storageName&&axLocalStorage.set(this.options.storageName,{}),this.targetDom.innerHTML=this.rawHTML?this.rawHTML:"",this.init(),"update"in this.handlers&&this.emit("update",""),this.options.onUpdate&&this.options.onUpdate.call(this),t&&t.call(this),this)}destroy(e){return this.flatData.forEach(e=>{e.labelDom.onclick=null,e.arrowDom.onclick=null,e.checkDom&&(e.checkDom.onclick=null),e.addDom&&(e.addDom.onclick=null),e.editDom&&(e.editDom.onclick=null),e.removeDom&&(e.removeDom.onclick=null),e.otherTools.forEach(e=>{e.dom.onclick=null})}),this.contentXhr&&this.contentXhr.abort(),this.destroyed=!0,this.options.storageName&&axLocalStorage.set(this.options.storageName,{}),"destroy"in this.handlers&&this.emit("destroy",""),this.options.onDestroy&&this.options.onDestroy.call(this),e&&e.call(this),this}save(e,t){return this.destroyed?this:!!this.options.storageName&&void setTimeout(()=>{let i=this.flatData.filter(e=>e.expanded).map(e=>e.id).filter(Boolean),s=this.flatData.filter(e=>e.disabled).map(e=>e.id).filter(Boolean),o=this.flatData.filter(e=>e.selected).map(e=>e.id).filter(Boolean),a=this.flatData.filter(e=>e.checked).map(e=>e.id).filter(Boolean),h=this.flatData.filter(e=>e.readonly).map(e=>e.id).filter(Boolean);e?(!e.hasOwnProperty("expanded")&&(e.expanded=i),!e.hasOwnProperty("disabled")&&(e.disabled=s),!e.hasOwnProperty("selected")&&(e.selected=o),!e.hasOwnProperty("checked")&&(e.checked=a),!e.hasOwnProperty("readonly")&&(e.readonly=h),!e.hasOwnProperty("content")&&(e.content=this.flatData),axLocalStorage.set(this.options.storageName,e)):axLocalStorage.set(this.options.storageName,{expanded:i,selected:o,checked:a,disabled:s,readonly:h,content:this.flatData});let n=axLocalStorage.get(this.options.storageName);return"save"in this.handlers&&this.emit("save",n),this.options.onSave&&this.options.onSave.call(this,n),t&&t.call(this,n),this},0)}on(e,t){return axAddPlan(e,t,this),this}emit(e,...t){axExePlan(e,this,...t)}off(e,t){return axDelPlan(e,t,this),this}}axInit("tree");